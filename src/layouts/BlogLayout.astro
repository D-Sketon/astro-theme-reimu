---
import type { CollectionEntry } from "astro:content";

import {
  COPYRIGHT,
  DISQUS,
  TWIKOO,
  VALINE,
  WALINE,
  SHARE,
  SPONSOR,
} from "../utils/config";
import Tag from "../components/post/Tag.astro";
import Nav from "../components/post/Nav.astro";
import ReadingCount from "../components/post/ReadingCount.astro";
import Copyright from "../components/post/Copyright.astro";
import CommentCount from "../components/post/CommentCount.astro";
import Outdate from "../components/post/Outdate.astro";
import Share from "../components/post/Share.astro";
import Sponsor from "../components/post/Sponsor.astro";

import MarkdownLayout from "./MarkdownLayout.astro";

type Props = {
  post: CollectionEntry<"blog">;
  frontMatter: CollectionEntry<"blog">["data"];
  url: string;
  headings?: Array<{
    depth: number;
    slug: string;
    text: string;
  }>;
  nav?: {
    prev: CollectionEntry<"blog"> | null;
    next: CollectionEntry<"blog"> | null;
  };
};

const { post, nav, frontMatter, url, headings = [] } = Astro.props;

const { title, tags = [] } = frontMatter;
const hasComment =
  frontMatter.comment !== false &&
  ((VALINE.enable && VALINE.appId && VALINE.appKey) ||
    (WALINE.enable && WALINE.serverURL) ||
    (TWIKOO.enable && TWIKOO.envId) ||
    (DISQUS.enable && DISQUS.shortname && DISQUS.count));
---

<MarkdownLayout frontMatter={frontMatter} headings={headings}>
  <Outdate
    outdated={frontMatter.outdated}
    updatedDate={frontMatter.updatedDate}
    pubDate={frontMatter.pubDate}
  />
  <slot />
  {
    (tags.length || COPYRIGHT.enable || hasComment) && (
      <footer class="article-footer" slot="footer">
        <Copyright frontMatter={frontMatter} url={url} />
        {SPONSOR?.enable && frontMatter.sponsor !== false && <Sponsor />}
        {SHARE?.length > 0 && <Share post={post} />}
        <Tag tags={tags} />
        {hasComment && (
          <>
            <CommentCount url={url} />
            <ReadingCount url={url} title={title} />
          </>
        )}
      </footer>
    )
  }
  {nav && <Nav {...nav} slot="nav" />}
</MarkdownLayout>

<style>
  .article-footer {
    font-size: 14px;
    margin: 0 36px 20px;

    @media screen and (max-width: 767px) {
      margin: 0 16px 20px;
    }

    &:before {
      content: "";
      display: block;
      margin-top: 12px;
      opacity: 0.3;
      height: 4px;
      background-image: linear-gradient(
        to right,
        var(--red-0) 50%,
        transparent 0%
      );
      background-size: 50px 4px;
      background-repeat: repeat-x;
      filter: drop-shadow(0px 0px 2px var(--red-1));
      transition: 0.3s;
    }

    &:after {
      content: "";
      display: block;
      height: 0;
      clear: both;
      visibility: hidden;
    }

    a {
      text-decoration: none;
    }
  }
</style>
