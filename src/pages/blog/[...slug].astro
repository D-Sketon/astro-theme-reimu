---
import { type CollectionEntry, getCollection } from "astro:content";

import BlogLayout from "../../layouts/BlogLayout.astro";

export async function getStaticPaths() {
  const posts = await getCollection("blog");
  return posts.map((post, index) => ({
    params: { slug: post.slug },
    props: {
      post,
      prev: posts[index - 1] || null,
      next: posts[index + 1] || null,
    },
  }));
}
type Props = {
  post: CollectionEntry<"blog">;
  prev: CollectionEntry<"blog"> | null;
  next: CollectionEntry<"blog"> | null;
};

const { post, prev, next } = Astro.props;
const { Content, headings } = await post.render();
---

<BlogLayout
  post={post}
  frontmatter={post.data}
  nav={{ prev, next }}
  url={`/blog/${post.slug}`}
  headings={headings}
>
  <Content />
</BlogLayout>

<script>
  import PhotoSwipeLightbox from "photoswipe/lightbox";
  import "photoswipe/style.css";

  document.addEventListener("astro:page-load", () => {
    document
      .querySelectorAll(".article-entry img")
      // @ts-expect-error - change from Element to HTMLImageElement
      .forEach((element: HTMLImageElement) => {
        if (
          element.parentElement?.tagName === "A" ||
          element.classList.contains("no-lightbox")
        )
          return;
        const a = document.createElement("a");
        a.href ? (a.href = element.src) : a.setAttribute("href", element.src);
        if (element.naturalWidth || element.naturalHeight) {
          a.dataset.pswpWidth = element.naturalWidth + "";
          a.dataset.pswpHeight = element.naturalHeight + "";
        } else {
          console.warn(
            "Image naturalWidth and naturalHeight cannot be obtained right now, fallback to onload."
          );
          element.onload = () => {
            a.dataset.pswpWidth = element.naturalWidth + "";
            a.dataset.pswpHeight = element.naturalHeight + "";
          };
        }
        a.target = "_blank";
        a.classList.add("article-gallery-item");
        element.parentNode?.insertBefore(a, element);
        element.parentNode?.removeChild(element);
        a.appendChild(element);
      });

    new PhotoSwipeLightbox({
      gallery: ".article-entry",
      children: "a.article-gallery-item",
      pswpModule: () => import("photoswipe"),
    }).init();
  });
</script>
