---
import { type CollectionEntry, getCollection } from "astro:content";

import BlogLayout from "../../layouts/BlogLayout.astro";

export async function getStaticPaths() {
  const posts = await getCollection("blog");
  return posts.map((post, index) => ({
    params: { slug: post.slug },
    props: {
      post,
      prev: posts[index - 1] || null,
      next: posts[index + 1] || null,
    },
  }));
}
type Props = {
  post: CollectionEntry<"blog">;
  prev: CollectionEntry<"blog"> | null;
  next: CollectionEntry<"blog"> | null;
};

const { post, prev, next } = Astro.props;
const { Content, headings } = await post.render();
---

<BlogLayout
  post={post}
  frontmatter={post.data}
  nav={{ prev, next }}
  url={`/blog/${post.slug}`}
  headings={headings}
>
  <Content />
</BlogLayout>

<script>
  import PhotoSwipeLightbox from "photoswipe/lightbox";
  import "photoswipe/style.css";

  document.addEventListener("astro:page-load", () => {
    document
      .querySelectorAll(".article-entry img")
      // @ts-expect-error - change from Element to HTMLImageElement
      .forEach((element: HTMLImageElement) => {
        if (
          element.parentElement?.tagName === "A" ||
          element.classList.contains("no-lightbox")
        )
          return;
        const a = document.createElement("a");
        a.href ? (a.href = element.src) : a.setAttribute("href", element.src);
        if (element.naturalWidth || element.naturalHeight) {
          a.dataset.pswpWidth = element.naturalWidth + "";
          a.dataset.pswpHeight = element.naturalHeight + "";
        } else {
          console.warn(
            "Image naturalWidth and naturalHeight cannot be obtained right now, fallback to onload."
          );
          element.onload = () => {
            a.dataset.pswpWidth = element.naturalWidth + "";
            a.dataset.pswpHeight = element.naturalHeight + "";
          };
        }
        a.target = "_blank";
        a.classList.add("article-gallery-item");
        element.parentNode?.insertBefore(a, element);
        element.parentNode?.removeChild(element);
        a.appendChild(element);
      });

    new PhotoSwipeLightbox({
      gallery: ".article-entry",
      children: "a.article-gallery-item",
      pswpModule: () => import("photoswipe"),
    }).init();
  });
</script>

<script>
  import mermaid from "mermaid";

  const saveOriginalData = () => {
    return new Promise<void>((resolve, reject) => {
      try {
        const els = document.querySelectorAll("pre.mermaid");
        let count = els.length;
        els.forEach((element) => {
          if (element.getAttribute("data-original-code") == null) {
            element.setAttribute("data-original-code", element.innerHTML);
          }
          count--;
          if (count == 0) {
            resolve();
          }
        });
      } catch (error) {
        reject(error);
      }
    });
  };

  const resetProcessed = () => {
    return new Promise<void>((resolve, reject) => {
      try {
        const els = document.querySelectorAll("pre.mermaid");
        let count = els.length;
        els.forEach((element) => {
          if (element.getAttribute("data-original-code") != null) {
            element.removeAttribute("data-processed");
            element.innerHTML =
              element.getAttribute("data-original-code") ?? "";
          }
          count--;
          if (count == 0) {
            resolve();
          }
        });
      } catch (error) {
        reject(error);
      }
    });
  };
  const loadMermaid = async (theme: any) => {
    mermaid.initialize({
      startOnLoad: false,
      theme,
    });
    await mermaid.run({
      querySelector: "pre.mermaid",
    });
  };
  const themeSetHandler = (e: any) => {
    let theme = e.detail.theme;
    if (e.detail.theme === "light") {
      theme = "default";
    } else if (e.detail.theme === "auto") {
      theme = window.matchMedia("(prefers-color-scheme: dark)").matches
        ? "dark"
        : "default";
    }
    saveOriginalData()
      .then(() => {
        resetProcessed();
      })
      .then(() => {
        loadMermaid(theme);
      })
      .catch(console.error);
  };
  const mermaidInit = () => {
    document.body.removeEventListener("theme-set", themeSetHandler);
    document.body.addEventListener("theme-set", themeSetHandler);

    let theme = localStorage.getItem("theme");
    if (theme === '"light"') {
      theme = "default";
    } else if (theme === '"auto"') {
      theme = window.matchMedia("(prefers-color-scheme: dark)").matches
        ? "dark"
        : "default";
    } else if (theme === '"dark"') {
      theme = "dark";
    } else {
      theme = "default";
    }
    if (theme === "dark" || theme === "default") {
      saveOriginalData()
        .then(() => {
          resetProcessed();
        })
        .then(() => {
          loadMermaid(theme);
        })
        .catch(console.error);
    }
  };
  document.addEventListener("astro:after-swap", mermaidInit);
  mermaidInit();
</script>
