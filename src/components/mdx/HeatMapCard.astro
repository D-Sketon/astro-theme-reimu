---
import { getCollection } from "astro:content";
import getReadingTime from "reading-time";

import { BASE_URL } from "../../utils/config";
import { getI18n } from "../../utils/i18n";

interface Props {
  levelStandard?: string;
}

const { levelStandard = "1000,5000,10000" } = Astro.props;

const allPosts = await getCollection("blog");
const articlesData = allPosts.map((post) => {
  const wordcount = post.body ? getReadingTime(post.body).words : 0;
  return {
    title: post.data.title,
    date: post.data.pubDate.toISOString(),
    updated:
      post.data.updatedDate?.toISOString() || post.data.pubDate.toISOString(),
    wordcount,
    url: `${BASE_URL}/blog/${post.slug}`,
  };
});

const i18n = getI18n().heatmap;
---

<div id="heatmap-tooltip"></div>
<div id="heatmap"></div>

<script define:vars={{ articlesData, i18n, levelStandard }} is:inline>
  function _p(key, params) {
    const keys = key.split(".");
    let result = i18n;
    for (let k of keys) {
      result = result[k];
    }
    if (Number(params) <= 1) {
      return result?.one?.replace("%s", params) || key;
    } else {
      return result?.other?.replace("%s", params) || key;
    }
  }

  var MONTH_NAMES = [
    "Jan",
    "Feb",
    "Mar",
    "Apr",
    "May",
    "Jun",
    "Jul",
    "Aug",
    "Sep",
    "Oct",
    "Nov",
    "Dec",
  ];

  var pluralize = (num, word) => `${num} ${word}${num <= 1 ? "" : "s"}`;

  function getTooltip(contributionDay, contributionDate) {
    const formattedDate = new Date(
      contributionDate.getTime() - contributionDate.getTimezoneOffset() * 60000
    )
      .toISOString()
      .split("T")[0];

    if (contributionDay.count === 0) {
      return `No writing on ${formattedDate}`;
    }

    const postText = pluralize(contributionDay.post, "post");
    const wordText = pluralize(contributionDay.count, "word");

    return `${postText} ${wordText} on ${formattedDate}`;
  }

  var heatmapTooltip = document.getElementById("heatmap-tooltip");

  function hideTooltip() {
    heatmapTooltip.style.display = "none";
  }

  function tileClickHandler(event) {
    const tile = event.target;
    if (!tile.classList.contains("tile")) return;

    const date = new Date(Number(tile.dataset.date));
    const dateStr = date.toISOString();

    const articles = articlesData.filter((article) => article.date === dateStr);

    const level = tile.dataset.level;
    const formattedDate = date.toLocaleDateString();
    let totalWords = 0;

    let html = `
      <div class="tooltip-header">
        <div class="tooltip-header-content">${formattedDate} (Level ${level})</div>
        <div class="popup-btn-close tooltip-close"></div>
      </div>
      <div class="tooltip-content">
        <ul>
    `;

    if (articles.length === 0) {
      html += `<li>${i18n.no_articles}</li>`;
    } else {
      articles.forEach((article) => {
        totalWords += article.wordcount;
        const wordText = _p("word", article.wordcount);
        html += `<li><a href="${article.url}">${article.title}</a> (${wordText})</li>`;
      });
    }

    const articleText = _p("article", articles.length);
    const wordText = _p("word", totalWords);
    const footerTemplate = `${articleText}, ${wordText}`;

    html += `
        </ul>
        <div class="tooltip-footer">
          ${footerTemplate}
        </div>
      </div>
    `;

    heatmapTooltip.innerHTML = html;

    const rect = tile.getBoundingClientRect();
    heatmapTooltip.style.display = "block";
    heatmapTooltip.style.visibility = "hidden";
    heatmapTooltip.style.left = "0px";

    const tooltipRect = heatmapTooltip.getBoundingClientRect();
    const tooltipWidth = tooltipRect.width;

    let left = rect.right + 10;
    if (left + tooltipWidth > window.innerWidth) {
      left = rect.left - tooltipWidth - 10;
    }

    heatmapTooltip.style.left = `${left}px`;
    heatmapTooltip.style.top = `${rect.top}px`;
    heatmapTooltip.style.display = "block";
    heatmapTooltip.style.visibility = "visible";

    const closeBtn = heatmapTooltip.querySelector(".tooltip-close");
    if (closeBtn) {
      closeBtn.addEventListener("click", hideTooltip);
    }

    document.addEventListener("click", function closeTooltipOnClickOutside(e) {
      if (e.target.classList.contains("tile")) {
        return;
      }
      if (!heatmapTooltip.contains(e.target) && e.target !== tile) {
        hideTooltip();
        document.removeEventListener("click", closeTooltipOnClickOutside);
      }
    });
  }

  function createCalendar(element, contributionData) {
    if (!element) {
      return;
    }
    element.innerHTML = `
      <div class="outer-box">
        <div class="year-select"></div>
        <div class="inner-box">
          <div class="calendar-container">
            ${["Mon", "Wed", "Fri"]
              .map((t) => `<span class="week">${t}</span>`)
              .join("")}
            <div class="legend">Less${new Array(5)
              .fill(0)
              .map((_, i) => `<i class="tile" data-level="${i}"></i>`)
              .join("")}More</div>
            <div class="tiles"></div>
          </div>
        </div>
      </div>
    `;

    const calendarContainer = element.querySelector(".calendar-container");
    const yearSelector = element.querySelector(".year-select");
    const tilesContainer = element.querySelector(".tiles");

    const allContributionData = completeContributionData(contributionData);
    const currentDisplayYear = new Date().getFullYear();

    yearSelector.innerHTML = Object.keys(allContributionData)
      .sort((a, b) => b - a)
      .map(
        (year) =>
          `<div class="year-option ${
            year == currentDisplayYear ? "active" : ""
          }">${year}</div>`
      )
      .join("");

    yearSelector.addEventListener("click", ({ target }) => {
      if (target.classList.contains("year-option")) {
        element.querySelector(".active")?.classList.remove("active");
        target.classList.add("active");
        generateYearContributions(target.textContent);
      }
    });

    const generateYearContributions = (year) => {
      tilesContainer.innerHTML = "";
      calendarContainer.querySelectorAll(".month").forEach((m) => m.remove());
      calendarContainer.querySelectorAll(".total").forEach((t) => t.remove());
      const data = allContributionData[year];
      const startRow = new Date(data[0].date).getDay();
      let latestMonth = -1;

      const monthFragment = document.createDocumentFragment();
      const tilesFragment = document.createDocumentFragment();

      let lastGridColumn = -1;

      const [tiles, totalStatistical] = data.reduce(
        ([tiles, stats], c, i) => {
          const date = new Date(c.date);
          const month = date.getMonth();

          stats.count += c.count;
          stats.post += c.post;

          if (date.getDay() === 0 && month !== latestMonth) {
            let gridColumn = 2 + Math.floor((i + startRow) / 7);
            if (gridColumn - lastGridColumn <= 1) {
              gridColumn += 2 - gridColumn + lastGridColumn;
            }
            lastGridColumn = gridColumn;
            latestMonth = month;
            const monthLabel = document.createElement("span");
            monthLabel.className = "month";
            monthLabel.textContent = MONTH_NAMES[month];
            monthLabel.style.gridColumn = gridColumn;
            monthFragment.append(monthLabel);
          }

          const tile = document.createElement("i");
          tile.className = "tile";
          tile.dataset.level = c.level;
          tile.title = getTooltip(c, date);
          tile.dataset.date = c.date;
          tile.addEventListener("click", tileClickHandler);
          tiles.push(tile);
          return [tiles, stats];
        },
        [[], { count: 0, post: 0 }]
      );

      if (tiles[0]) {
        tiles[0].style.gridRow = startRow + 1;
      }

      tilesFragment.append(...tiles);

      calendarContainer.append(monthFragment);
      tilesContainer.append(tilesFragment);

      calendarContainer.insertAdjacentHTML(
        "beforeend",
        `<div class="total">${pluralize(
          totalStatistical.post,
          "post"
        )} ${pluralize(totalStatistical.count, "word")} in ${year}</div>`
      );
    };

    generateYearContributions(currentDisplayYear);
  }

  function completeContributionData(userData) {
    userData.sort((a, b) => a.date - b.date);

    const startDate = new Date(userData[0].date);
    const currentDate = new Date();

    const allData = {};
    const userDataMap = {};
    userData.forEach((data) => {
      const dataDate = new Date(data.date);
      const key = `${dataDate.getFullYear()}-${dataDate.getMonth()}-${dataDate.getDate()}`;
      userDataMap[key] = data;
    });

    for (
      let year = startDate.getFullYear();
      year <= currentDate.getFullYear();
      year++
    ) {
      const [startYear, endYear] =
        year === currentDate.getFullYear()
          ? [
              new Date(
                new Date(currentDate).setDate(currentDate.getDate() - 365)
              ),
              new Date(currentDate.getTime() + 86400000),
            ]
          : [new Date(year, 0, 1), new Date(year + 1, 0, 1)];

      const yearData = [];
      for (let d = startYear; d < endYear; d.setDate(d.getDate() + 1)) {
        const key = `${d.getFullYear()}-${d.getMonth()}-${d.getDate()}`;
        yearData.push(
          userDataMap[key] || {
            level: 0,
            date: d.getTime(),
            count: 0,
            post: 0,
          }
        );
      }
      allData[year] = yearData;
    }
    return allData;
  }

  function getLevelFromWordCount(totalCount) {
    const levels = levelStandard.split(",").map(Number);
    if (totalCount <= 0) return 0;
    if (totalCount <= levels[0]) return 1;
    if (totalCount <= levels[1]) return 2;
    if (totalCount <= levels[2]) return 3;
    return 4;
  }

  var currentDate = new Date();

  function transformArticlesData(articlesData) {
    const dailyStats = articlesData.reduce((map, { date, wordcount }) => {
      if (new Date(date) > currentDate) {
        return map;
      }
      const entry = map.get(date) ?? { count: 0, post: 0 };
      return map.set(date, {
        count: entry.count + wordcount,
        post: entry.post + 1,
      });
    }, new Map());

    return Array.from(dailyStats, ([dayStr, { count, post }]) => ({
      level: getLevelFromWordCount(count),
      date: new Date(dayStr).getTime(),
      count,
      post,
    }));
  }

  createCalendar(
    document.querySelector("#heatmap"),
    transformArticlesData(articlesData)
  );
</script>

<style is:global>
  .outer-box {
    width: 100%;
    display: flex;
    flex-direction: row;
    justify-content: center;
    margin: 12px 0;
    --heat-level-0: color-mix(in srgb, var(--red-0) 10%, white);
    --heat-level-1: color-mix(in srgb, var(--red-0) 40%, white);
    --heat-level-2: color-mix(in srgb, var(--red-0) 80%, white);
    --heat-level-3: var(--red-0);
    --heat-level-4: color-mix(in srgb, var(--red-0) 80%, black);
  }

  [data-theme="dark"] .outer-box {
    --heat-level-0: #161b22;
    --heat-level-1: color-mix(in srgb, var(--red-0) 30%, transparent);
    --heat-level-2: color-mix(in srgb, var(--red-0) 50%, transparent);
    --heat-level-3: color-mix(in srgb, var(--red-0) 70%, transparent);
    --heat-level-4: var(--red-0);
  }

  .calendar-container {
    display: grid;
    grid: auto repeat(7, 10px) auto / auto repeat(53, 10px);
    gap: 3px;
    margin: 0 1px 1px;
    width: fit-content;
    font-size: 12px;
    padding: 12px;
    border: solid 1px var(--color-border);
    border-radius: 8px;
  }

  .month {
    grid-row: 1 / 2;
    margin-bottom: -2px;
  }

  .week {
    grid-row: 3;
    grid-column: 1 / 2;
    line-height: 10px;
    margin-right: 2px;
  }

  .week + .week {
    grid-row: 5;
  }

  .week + .week + .week {
    grid-row: 7;
  }

  .tiles {
    grid-column: 2 / 56;
    grid-row: 2 / 9;
    display: grid;
    grid-auto-flow: column;
    grid-template: subgrid / subgrid;
  }

  .tile {
    width: 10px;
    height: 10px;
    border-radius: 2px;
    outline: 1px solid color-mix(in srgb, var(--red-2) 10%, transparent);
    outline-offset: -1px;
  }

  .tile[data-level="0"] {
    background: var(--heat-level-0);
  }

  .tile[data-level="1"] {
    background: var(--heat-level-1);
  }

  .tile[data-level="2"] {
    background: var(--heat-level-2);
  }

  .tile[data-level="3"] {
    background: var(--heat-level-3);
  }

  .tile[data-level="4"] {
    background: var(--heat-level-4);
  }

  i.tile:hover {
    outline: 1px solid var(--red-2);
    cursor: pointer;
  }

  #heatmap-tooltip {
    position: fixed;
    z-index: 1000;
    padding: 8px;
    background-color: var(--color-background);
    border-radius: 8px;
    border: solid 1px var(--color-border);
    box-shadow: var(--shadow-meta);
    font-size: 12px;
    color: var(--color-default);
    max-width: 250px;
    display: none;
  }

  #heatmap-tooltip ul {
    margin: 0 20px;
    line-height: 1.8em;
    list-style: disc;
    margin-top: 0.9em;
    margin-bottom: 0.9em;
  }

  #heatmap-tooltip li:hover::marker {
    transition: color 0.2s;
    color: var(--red-1);
  }

  #heatmap-tooltip a {
    color: var(--color-link);
    text-decoration: none;
    word-break: break-word;
  }

  #heatmap-tooltip a:hover {
    text-decoration: underline;
  }

  #heatmap-tooltip .tooltip-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  #heatmap-tooltip .tooltip-header-content {
    font-weight: bold;
    font-size: 16px;
    color: var(--color-default);
  }

  #heatmap-tooltip .tooltip-close {
    padding: 0 0 0 8px;
    color: var(--color-link);
    font-weight: bold;
    font-size: 12px;
    cursor: pointer;
  }

  #heatmap-tooltip .tooltip-content {
    max-height: 300px;
    overflow-y: auto;
    line-height: 1.2;
  }

  .total {
    grid-column: 2 / 30;
    grid-row: 9;
    margin-top: 4px;
  }

  .legend {
    grid-column: 30 / 53;
    grid-row: 9;
    margin-top: 4px;
    display: flex;
    gap: 6px;
    justify-content: right;
    align-items: center;
  }

  .year-select {
    height: 146px;
    padding: 4px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 4px;
    flex-shrink: 0;
    box-sizing: border-box;
  }

  .year-select::-webkit-scrollbar {
    width: 8px;
    height: 8px;
    background-color: transparent;
  }

  .year-select::-webkit-scrollbar-track {
    background-color: transparent;
  }

  .year-option {
    padding: 4px 20px;
    border-radius: 8px;
    cursor: pointer;
  }

  .year-option:hover {
    background-color: var(--heat-level-1);
  }

  .year-option.active {
    background-color: var(--heat-level-2);
    color: white;
  }

  .inner-box {
    overflow: auto;
  }

  .inner-box::-webkit-scrollbar {
    width: 8px;
    height: 8px;
    background-color: transparent;
  }

  .inner-box::-webkit-scrollbar-track {
    background-color: transparent;
  }

  @media screen and (max-width: 768px) {
    .year-select {
      width: 100%;
      height: auto;
      flex-direction: row;
      justify-content: start;
      align-items: center;
    }

    .outer-box {
      flex-direction: column;
    }

    .inner-box {
      width: 100%;
      overflow-x: auto;
    }
  }
</style>
