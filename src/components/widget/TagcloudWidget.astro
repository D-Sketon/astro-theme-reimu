---
import { getCollection } from "astro:content";

import { BASE_URL } from "../../utils/config";
import { __ } from "../../utils/i18n";

async function getTags() {
  const posts = await getCollection("blog");
  const tags = new Map<string, number>();

  posts.forEach((post) => {
    post.data.tags?.forEach((tag: string) => {
      tags.set(tag, (tags.get(tag) || 0) + 1);
    });
  });

  return tags;
}

const tags = await getTags();

// Calculate font sizes
const counts = [...tags.values()];
const minCount = Math.min(...counts);
const maxCount = Math.max(...counts);
const minSize = 10;
const maxSize = 20;

function getFontSize(count: number): number {
  if (minCount === maxCount) return 15; // default size
  return (
    minSize + ((count - minCount) / (maxCount - minCount)) * (maxSize - minSize)
  );
}
---

{
  tags.size > 0 && (
    <div class="widget-wrapper">
      <div class="widget-wrap" data-aos="fade-up">
        <h3 class="widget-title">{__("tagcloud")}</h3>
        <div class="widget">
          <div class="tagcloud">
            {[...tags.entries()]
              .sort((a, b) => b[1] - a[1])
              .map(([tag, count]) => (
                <a
                  href={`${BASE_URL}/tags/${encodeURIComponent(tag)}`}
                  style={`font-size: ${getFontSize(count)}px;`}
                  data-pjax-state=""
                >
                  {tag}
                </a>
              ))}
          </div>
        </div>
      </div>
    </div>
  )
}
